#!/usr/bin/env bash

TOP=..
LD=$(command -v ld)
CC=$(command -v gcc)

# What are we building?

TGT=$1
case $TGT in
  "galua")
     NEWSTATE="lua_newstate_nondbg"
     WRITESTRING="galua_writestring_nondbg"
  ;;
  "galua-dbg")
     NEWSTATE="lua_newstate_dbg"
     WRITESTRING="galua_writestring_dbg"
  ;;
  *)
     echo "Usage: $(basename $0) (galua | galua-dbg)"
     exit 1
  ;;
esac

echo "Target $TGT"

################################################################################
# Make the entry point for "newstate".
$CC -fPIC -DNEWSTATE=${NEWSTATE} -DWRITESTRING=${WRITESTRING} -c newstate.c


################################################################################
# Building library

LIBNAME=lib${TGT}.a

DIST_DIR=$(stack path --dist-dir)

# Figure out which libraries we need to package together.
HS_LIBRARIES_LIST_FILE=$TOP/$TGT/$DIST_DIR/build/autogen/HS_LIBRARIES_LIST
HS_LIBRARY_PATHS_LIST_FILE=$TOP/$TGT/$DIST_DIR/build/autogen/HS_LIBRARY_PATHS_LIST
EXTRA_LIBRARIES_LIST_FILE=$TOP/$TGT/$DIST_DIR/build/autogen/EXTRA_LIBRARIES_LIST

if [ ! -e "$HS_LIBRARIES_LIST_FILE" ]; then
  echo "Failed to find the file \`HS_LIBRARIES_LIST\` for \`$TGT\`."
  echo "*** It is generated by \`Setup.hs\` after configuration."
  echo "*** Perhaps \`$TGT\` was not built?"
  exit 2
fi

HS_LIBRARIES_LIST=$(cat $HS_LIBRARIES_LIST_FILE)
HS_LIBRARY_PATHS_LIST=$(cat $HS_LIBRARY_PATHS_LIST_FILE)
EXTRA_LIBRARIES_LIST=$(cat $EXTRA_LIBRARIES_LIST_FILE)

declare -a HS_LD_FLAGS
declare -a C_LD_FLAGS

IFS=$'\n'; for lib in $HS_LIBRARY_PATHS_LIST
do
        HS_LD_FLAGS+=("-L$lib")
done

IFS=$'\n'; for lib in $HS_LIBRARIES_LIST
do
        HS_LD_FLAGS+=("-l$lib")
done

IFS=$'\n'; for lib in $EXTRA_LIBRARIES_LIST
do
        C_LD_FLAGS+=("-l$lib")
done


# What OS are we running on?
UNAME=$(uname -s)
ARCH=$(uname -m)

echo "  Building for $UNAME-$ARCH"

function COMMON_CFLAGS() {
cat <<EOF
-g
-std=gnu99
-I$TOP/galua-c/inplace/include/galua
-o$TGT
-L.
-l$TGT
$(for i in ${C_LD_FLAGS[@]}; do echo $i; done)
EOF
}



case $UNAME in
  "Linux" | "FreeBSD" )

      echo "  Building library $LIBNAME"
      TMP_DIR=$(mktemp -d .build.XXXX)

      cut --complement -b 1 lua_api.txt | sort > $TMP_DIR/API

      sed 's/^/--require-defined=/' <$TMP_DIR/API >$TMP_DIR/REQ

      echo "{"                   >  $TMP_DIR/DYN
      sed 's/$/;/' <$TMP_DIR/API >> $TMP_DIR/DYN
      echo "};"                  >> $TMP_DIR/DYN


      $LD -o $LIBNAME \
          -arch $ARCH \
          --relocatable \
          --whole-archive \
          --retain-symbols-file=$TMP_DIR/API \
          newstate.o \
          liblualibs.a \
          "${HS_LD_FLAGS[@]}"


      echo "  Stripping library $LIBNAME"
      nm -f posix $LIBNAME | awk '{print $1}' | sort > $TMP_DIR/ALL
      comm -23 $TMP_DIR/ALL $TMP_DIR/API > $TMP_DIR/LOCALIZE
      objcopy --localize-symbols=$TMP_DIR/LOCALIZE $LIBNAME


      C_LD_FLAGS+=("-lpthread")

      # Hmm?
      C_LD_FLAGS+=("-no-pie")
      C_LD_FLAGS+=("-rdynamic")

      echo "  Building executable $TGT"
      $CC main.c $(COMMON_CFLAGS)
      rm -rf $TMP_DIR

  # -Wl,--dynamic-list=$TMP_DIR/DYN \
  ;;
  "Darwin")

    echo "  Building library $LIBNAME"
    $LD -r -o $LIBNAME \
       -arch x86_64 \
       -exported_symbols_list lua_api.txt \
       newstate.o \
       liblualibs.a \
       "${HS_LD_FLAGS[@]}"

    echo "  Building executable $TGT"
    $CC main.c \
          $(COMMON_CFLAGS) \
          -Wl,-no_compact_unwind

  ;;
  *) echo "Unknown OS: $UNAME"
     exit 3
esac




################################################################################
# Generate `pkgconfig` file
################################################################################

PKG_CONFIG_FILE=$TGT.pc

echo "  Generating \`pkgconfig\` file $PKG_CONFIG_FILE"


cat >$PKG_CONFIG_FILE <<EOF
# Please define 'exec_prefix', 'includedir', and 'libdir' during install.
Name:         libgalua-dbg
Version:      0.1
Description:  the '$TGT' library, used for debugging Lua.
Cflags:       -I\${includedir}
Libs:         -L\${libdir} -l$TGT ${C_LD_FLAGS[@]}
EOF




